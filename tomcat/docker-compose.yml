services:
  pmacho-tomcat-init:
    image: tomcat:11
    command: >
      sh -c '
        if [ ! -e /tmp/webapps/ROOT ]; then
          mkdir -p /tmp/webapps;
          cp -a /usr/local/tomcat/webapps.dist/ROOT /tmp/webapps;
        fi

        if [ ! -e /tmp/conf/server.xml ]; then
          mkdir -p /tmp/conf;
          cp -a /usr/local/tomcat/conf/. /tmp/conf;
        fi
      '
    volumes:
      - ./webapps:/tmp/webapps
      - ./conf:/tmp/conf
    restart: no

  pmacho-tomcat:
    image: tomcat:11
    depends_on:
      pmacho-tomcat-init:
        condition: service_completed_successfully
    ports:
      - 8080:8080
    volumes:
      - ./webapps:/usr/local/tomcat/webapps
      - ./conf:/usr/local/tomcat/conf
    restart: unless-stopped

